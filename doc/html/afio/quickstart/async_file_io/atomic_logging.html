<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>A multiprocess safe log file</title>
<link rel="stylesheet" href="../../../../../libs/afio/doc/html/myboostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.76.1">
<link rel="home" href="../../../afio.html" title="Chapter&#160;1.&#160;Boost.AFIO 1.30">
<link rel="up" href="../async_file_io.html" title="Asynchronous file i/o">
<link rel="prev" href="file_concat.html" title="A less toy example: Concatenating files">
<link rel="next" href="so_what.html" title="What benefit does asynchronous file i/o bring me? A demonstration of AFIO's power">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../boost.png"></td>
<td align="center"><a href="../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="file_concat.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../afio.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="so_what.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="afio.quickstart.async_file_io.atomic_logging"></a><a class="link" href="atomic_logging.html" title="A multiprocess safe log file">A multiprocess
        safe log file</a>
</h4></div></div></div>
<p>
          TripleGit, the forthcoming reliable graph database store, uses a neat trick
          to avoid having to use file locking during transaction commits, thus allowing
          multiple processes to concurrently read and write the graph store without
          file locking. Each collection of hashes which form the tree which makes
          up some given version of the graph is itself a hashed object in the content
          addressable store, and to transact a new version of that graph one takes
          the following steps:
        </p>
<p>
          1. Atomically append a new 512 bit (64 byte) record to the log file for
          the graph. This record contains the 256 bit hash (32 bytes) of the tree
          object representing the new version, two bytes of the record index where
          we think this entry will append modulo 16 bits (2 bytes), the local version
          number we think this ought to be (2 bytes), the current date and time (8
          bytes), reserved fields (4 bytes) and a SipHash of the 48 bytes preceding
          the final 12 bytes of the record plus the 64 bytes of the last known good
          record, and finally four bytes of Hamming (127, 120) coding for the preceding
          60 bytes (480 bits) which enable one bitrot per 15 bytes to be healed.
        </p>
<p>
          2. If more than one thread or process appends simultaneously, due to the
          atomicity only one will come first. We can tell if we "won" by
          reading backwards from the end until we find our entry which if it has
          the correct record index we know it is now the canonical new version. If
          it does not have the correct index, we will have to recalculate a new transaction
          from the latest known good entry or return an error to the end user as
          per their request.
        </p>
<p>
          3. It may now occur to you that surely the log file will grow forever!
          Luckily, modern filing systems are <span class="emphasis"><em>extent based</em></span> which
          means you can <span class="quote">&#8220;<span class="quote">punch holes</span>&#8221;</span> into file storage, and AFIO has
          a function for that called <a class="link" href="../../reference/classes/async_file_io_dispatcher_base/zero_2_batch.html" title="zero (batch)"><code class="computeroutput"><span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">zero</span><span class="special">()</span></code></a>
          which ostensibly zeros a region of a file, but will also deallocate it
          if the filing system supports it. In our example below, we simply chop
          off the front of the log file such that no more than 4Kb of data is actually
          stored on disc, even if the log file appears to be many gigabytes or even
          terabytes in size!
        </p>
<p>
          (It isn't shown in the example code below, but the 8 byte hash is used
          to roll back the log to a known good state in the event of sudden power
          loss which can be detected by spotting if the file begins with zeros as
          for proper shutdown the dud entries in the log are removed, and the entries
          compacted. One examines the index at the end of the file and walks backwards
          for about 128Kb, healing any bit flips and checking the hashs. If any do
          not match up, the entire index is parsed from the beginning up until the
          first entry with an incorrect hash, at which point the index is truncated)
        </p>
<pre class="programlisting"><span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*</span><span class="identifier">argv</span><span class="special">[])</span>
<span class="special">{</span>
    <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">BOOST_AFIO_V1_NAMESPACE</span><span class="special">;</span>
    <span class="keyword">using</span> <span class="identifier">BOOST_AFIO_V1_NAMESPACE</span><span class="special">::</span><span class="identifier">off_t</span><span class="special">;</span>
<span class="preprocessor">#if</span> <span class="identifier">AFIO_STANDALONE</span>
    <span class="keyword">using</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">to_string</span><span class="special">;</span>
<span class="preprocessor">#else</span>
    <span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">to_string</span><span class="special">;</span>
<span class="preprocessor">#endif</span>
    <span class="keyword">typedef</span> <span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="identifier">ratio</span><span class="special">&lt;</span><span class="number">1</span><span class="special">,</span> <span class="number">1</span><span class="special">&gt;&gt;</span> <span class="identifier">secs_type</span><span class="special">;</span>
    <span class="keyword">double</span> <span class="identifier">traditional_locks</span><span class="special">=</span><span class="number">0</span><span class="special">,</span> <span class="identifier">atomic_log_locks</span><span class="special">=</span><span class="number">0</span><span class="special">;</span>
    <span class="keyword">try</span> <span class="special">{</span> <span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">remove_all</span><span class="special">(</span><span class="string">"testdir"</span><span class="special">);</span> <span class="special">}</span> <span class="keyword">catch</span><span class="special">(...)</span> <span class="special">{}</span>

    <span class="identifier">size_t</span> <span class="identifier">totalwriters</span><span class="special">=</span><span class="number">2</span><span class="special">,</span> <span class="identifier">writers</span><span class="special">=</span><span class="identifier">totalwriters</span><span class="special">;</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">argc</span><span class="special">&gt;</span><span class="number">1</span><span class="special">)</span>
      <span class="identifier">writers</span><span class="special">=</span><span class="identifier">totalwriters</span><span class="special">=</span><span class="identifier">atoi</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">]);</span>
    <span class="special">{</span>
      <span class="keyword">auto</span> <span class="identifier">dispatcher</span> <span class="special">=</span> <span class="identifier">make_async_file_io_dispatcher</span><span class="special">();</span>
      <span class="keyword">auto</span> <span class="identifier">mkdir</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">dir</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"testdir"</span><span class="special">,</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Create</span><span class="special">)));</span>
      <span class="keyword">auto</span> <span class="identifier">statfs_</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">statfs</span><span class="special">(</span><span class="identifier">mkdir</span><span class="special">,</span> <span class="identifier">fs_metadata_flags</span><span class="special">::</span><span class="identifier">All</span><span class="special">));</span>
      <span class="keyword">auto</span> <span class="identifier">statfs</span><span class="special">(</span><span class="identifier">statfs_</span><span class="special">.</span><span class="identifier">first</span><span class="special">.</span><span class="identifier">get</span><span class="special">());</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"The filing system holding our test directory is "</span> <span class="special">&lt;&lt;</span> <span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_fstypename</span> <span class="special">&lt;&lt;</span> <span class="string">" and has features:"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="preprocessor">#define</span> <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">field</span><span class="special">,</span> <span class="special">...)</span> <span class="special">\</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"  f_flags."</span> <span class="special">#</span><span class="identifier">field</span> <span class="string">": "</span><span class="special">;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_flags</span><span class="special">.</span><span class="identifier">field</span> <span class="identifier">__VA_ARGS__</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">rdonly</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">noexec</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">nosuid</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">acls</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">xattr</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">compression</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">extents</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">filecompression</span><span class="special">);</span>
<span class="preprocessor">#undef</span> <span class="identifier">PRINT_FIELD</span>
<span class="preprocessor">#define</span> <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">field</span><span class="special">,</span> <span class="special">...)</span> <span class="special">\</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"  f_"</span> <span class="special">#</span><span class="identifier">field</span> <span class="string">": "</span><span class="special">;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_</span><span class="special">##</span><span class="identifier">field</span> <span class="identifier">__VA_ARGS__</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">bsize</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">iosize</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">blocks</span><span class="special">,</span> <span class="special">&lt;&lt;</span> <span class="string">" ("</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_blocks</span><span class="special">*</span><span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_bsize</span> <span class="special">/</span> <span class="number">1024.0</span> <span class="special">/</span> <span class="number">1024.0</span> <span class="special">/</span> <span class="number">1024.0</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">" Gb)"</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">bfree</span><span class="special">,</span> <span class="special">&lt;&lt;</span> <span class="string">" ("</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_bfree</span><span class="special">*</span><span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_bsize</span> <span class="special">/</span> <span class="number">1024.0</span> <span class="special">/</span> <span class="number">1024.0</span> <span class="special">/</span> <span class="number">1024.0</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">" Gb)"</span><span class="special">);</span>
      <span class="identifier">PRINT_FIELD</span><span class="special">(</span><span class="identifier">bavail</span><span class="special">,</span> <span class="special">&lt;&lt;</span> <span class="string">" ("</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_bavail</span><span class="special">*</span><span class="identifier">statfs</span><span class="special">.</span><span class="identifier">f_bsize</span> <span class="special">/</span> <span class="number">1024.0</span> <span class="special">/</span> <span class="number">1024.0</span> <span class="special">/</span> <span class="number">1024.0</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">" Gb)"</span><span class="special">);</span>
<span class="preprocessor">#undef</span> <span class="identifier">PRINT_FIELD</span>
    <span class="special">}</span>
    <span class="keyword">if</span><span class="special">(</span><span class="number">1</span><span class="special">)</span>
    <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\nBenchmarking traditional file locks with "</span> <span class="special">&lt;&lt;</span> <span class="identifier">writers</span> <span class="special">&lt;&lt;</span> <span class="string">" concurrent writers ...\n"</span><span class="special">;</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">thread</span><span class="special">&gt;</span> <span class="identifier">threads</span><span class="special">;</span>
      <span class="identifier">atomic</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">&gt;</span> <span class="identifier">done</span><span class="special">(</span><span class="keyword">true</span><span class="special">);</span>
      <span class="identifier">atomic</span><span class="special">&lt;</span><span class="identifier">size_t</span><span class="special">&gt;</span> <span class="identifier">attempts</span><span class="special">(</span><span class="number">0</span><span class="special">),</span> <span class="identifier">successes</span><span class="special">(</span><span class="number">0</span><span class="special">);</span>
      <span class="keyword">for</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">n</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">n</span><span class="special">&lt;</span><span class="identifier">writers</span><span class="special">;</span> <span class="identifier">n</span><span class="special">++)</span>
      <span class="special">{</span>
        <span class="identifier">threads</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">thread</span><span class="special">([&amp;</span><span class="identifier">done</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">attempts</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">successes</span><span class="special">,</span> <span class="identifier">n</span><span class="special">]{</span>
          <span class="keyword">try</span>
          <span class="special">{</span>
            <span class="comment">// Create a dispatcher</span>
            <span class="keyword">auto</span> <span class="identifier">dispatcher</span> <span class="special">=</span> <span class="identifier">make_async_file_io_dispatcher</span><span class="special">();</span>
            <span class="comment">// Schedule opening the log file for writing log entries</span>
            <span class="keyword">auto</span> <span class="identifier">logfile</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"testdir/log"</span><span class="special">,</span>
                <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Create</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">ReadWrite</span><span class="special">)));</span>
            <span class="comment">// Retrieve any errors which occurred</span>
            <span class="identifier">logfile</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
            <span class="comment">// Wait until all threads are ready</span>
            <span class="keyword">while</span><span class="special">(</span><span class="identifier">done</span><span class="special">)</span> <span class="special">{</span> <span class="identifier">this_thread</span><span class="special">::</span><span class="identifier">yield</span><span class="special">();</span> <span class="special">}</span>
            <span class="keyword">while</span><span class="special">(!</span><span class="identifier">done</span><span class="special">)</span>
            <span class="special">{</span>
              <span class="comment">// Traditional file locks are very simple: try to exclusively create the lock file.</span>
              <span class="comment">// If you succeed, you have the lock.</span>
              <span class="keyword">auto</span> <span class="identifier">lockfile</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"testdir/log.lock"</span><span class="special">,</span>
                <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">CreateOnlyIfNotExist</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Write</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">TemporaryFile</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">DeleteOnClose</span><span class="special">)));</span>
              <span class="identifier">attempts</span><span class="special">.</span><span class="identifier">fetch_add</span><span class="special">(</span><span class="number">1</span><span class="special">,</span> <span class="identifier">memory_order_relaxed</span><span class="special">);</span>
              <span class="comment">// v1.4 of the AFIO engine will return error_code instead of exceptions for this</span>
              <span class="keyword">try</span> <span class="special">{</span> <span class="identifier">lockfile</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span> <span class="special">}</span> <span class="keyword">catch</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">system_error</span> <span class="special">&amp;</span><span class="identifier">e</span><span class="special">)</span> <span class="special">{</span> <span class="identifier">this_thread</span><span class="special">::</span><span class="identifier">sleep_for</span><span class="special">(</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">milliseconds</span><span class="special">(</span><span class="number">1</span><span class="special">));</span> <span class="keyword">continue</span><span class="special">;</span> <span class="special">}</span>
              <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">logentry</span><span class="special">(</span><span class="string">"I am log writer "</span><span class="special">),</span> <span class="identifier">mythreadid</span><span class="special">(</span><span class="identifier">to_string</span><span class="special">(</span><span class="identifier">n</span><span class="special">)),</span> <span class="identifier">logentryend</span><span class="special">(</span><span class="string">"!\n"</span><span class="special">);</span>
              <span class="comment">// Fetch the size</span>
              <span class="identifier">off_t</span> <span class="identifier">where</span><span class="special">=</span><span class="identifier">logfile</span><span class="special">-&gt;</span><span class="identifier">lstat</span><span class="special">().</span><span class="identifier">st_size</span><span class="special">,</span> <span class="identifier">entrysize</span><span class="special">=</span><span class="identifier">logentry</span><span class="special">.</span><span class="identifier">size</span><span class="special">()+</span><span class="identifier">mythreadid</span><span class="special">.</span><span class="identifier">size</span><span class="special">()+</span><span class="identifier">logentryend</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span>
              <span class="comment">// Schedule extending the log file</span>
              <span class="keyword">auto</span> <span class="identifier">extendlog</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">truncate</span><span class="special">(</span><span class="identifier">logfile</span><span class="special">,</span> <span class="identifier">where</span><span class="special">+</span><span class="identifier">entrysize</span><span class="special">));</span>
              <span class="comment">// Schedule writing the new entry</span>
              <span class="keyword">auto</span> <span class="identifier">writetolog</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">write</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">extendlog</span><span class="special">,</span> <span class="special">{</span><span class="identifier">logentry</span><span class="special">,</span> <span class="identifier">mythreadid</span><span class="special">,</span> <span class="identifier">logentryend</span><span class="special">},</span> <span class="identifier">where</span><span class="special">)));</span>
              <span class="comment">// Schedule releasing the lock</span>
              <span class="keyword">auto</span> <span class="identifier">closelockfile</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">close</span><span class="special">(</span><span class="identifier">lockfile</span><span class="special">));</span>
              <span class="comment">// Fetch errors from the last operation first to avoid sleep-wake cycling</span>
              <span class="identifier">closelockfile</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
              <span class="identifier">extendlog</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
              <span class="identifier">writetolog</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
              <span class="identifier">successes</span><span class="special">.</span><span class="identifier">fetch_add</span><span class="special">(</span><span class="number">1</span><span class="special">,</span> <span class="identifier">memory_order_relaxed</span><span class="special">);</span>
            <span class="special">}</span>
          <span class="special">}</span>
          <span class="keyword">catch</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">system_error</span> <span class="special">&amp;</span><span class="identifier">e</span><span class="special">)</span> <span class="special">{</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: test exits via system_error code "</span> <span class="special">&lt;&lt;</span> <span class="identifier">e</span><span class="special">.</span><span class="identifier">code</span><span class="special">().</span><span class="identifier">value</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">"("</span> <span class="special">&lt;&lt;</span> <span class="identifier">e</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">")"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="identifier">abort</span><span class="special">();</span> <span class="special">}</span>
          <span class="keyword">catch</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span> <span class="special">&amp;</span><span class="identifier">e</span><span class="special">)</span> <span class="special">{</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: test exits via exception ("</span> <span class="special">&lt;&lt;</span> <span class="identifier">e</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">")"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="identifier">abort</span><span class="special">();</span> <span class="special">}</span>
          <span class="keyword">catch</span><span class="special">(...)</span> <span class="special">{</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: test exits via unknown exception"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="identifier">abort</span><span class="special">();</span> <span class="special">}</span>
        <span class="special">}));</span>
      <span class="special">}</span>
      <span class="keyword">auto</span> <span class="identifier">begin</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
      <span class="identifier">done</span><span class="special">=</span><span class="keyword">false</span><span class="special">;</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">this_thread</span><span class="special">::</span><span class="identifier">sleep_for</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">seconds</span><span class="special">(</span><span class="number">20</span><span class="special">));</span>
      <span class="identifier">done</span><span class="special">=</span><span class="keyword">true</span><span class="special">;</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Waiting for threads to exit ..."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
      <span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">i</span> <span class="special">:</span> <span class="identifier">threads</span><span class="special">)</span>
        <span class="identifier">i</span><span class="special">.</span><span class="identifier">join</span><span class="special">();</span>
      <span class="keyword">auto</span> <span class="identifier">end</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
      <span class="keyword">auto</span> <span class="identifier">diff</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration_cast</span><span class="special">&lt;</span><span class="identifier">secs_type</span><span class="special">&gt;(</span><span class="identifier">end</span><span class="special">-</span><span class="identifier">begin</span><span class="special">);</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"For "</span> <span class="special">&lt;&lt;</span> <span class="identifier">writers</span> <span class="special">&lt;&lt;</span> <span class="string">" concurrent writers, achieved "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">attempts</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">())</span> <span class="special">&lt;&lt;</span> <span class="string">" attempts per second with a "</span>
      <span class="string">"success rate of "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">successes</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">())</span> <span class="special">&lt;&lt;</span> <span class="string">" writes per second which is a "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="number">100.0</span><span class="special">*</span><span class="identifier">successes</span><span class="special">/</span><span class="identifier">attempts</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">"% success rate."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
      <span class="identifier">traditional_locks</span><span class="special">=</span><span class="identifier">successes</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="comment">/* Some notes on this mutual exclusion via atomic append to a file algorithm ...

    How this algorithm works is interesting, as it sort of resembles distributed mutual exclusion by
    message passing of which the algorithms by Suzuki and Kasami, Maekawa and Ricart and Agrawala are the
    most famous. However, we aren't passing messages, we're appending messages to a file, and we are therefore
    guaranteed that appends are atomic, and that means that unlike message passing where messages can arrive
    in any order, everyone in this algorithm sees an identical ordering of messages which is effectively a
    free Lamport clock. This, unfortunately, is where the good differences end.

    The big unhelpful difference is that locking actors aren't around to respond to messages unless they are
    trying to claim the lock. This creates a mix of rapidly oscillating messaging nodes and a potentially very
    high rate of nodes failing to respond, and this makes the traditional algorithms mentioned above problematic.
    I have therefore come up with something of my own:

    1. First thing someone who wants the lock does is to append an "I am interested in this lock" message.
    This registers the sequential priority of this claim relative to other claims based on the relative
    offset the message ends up landing at.

    2. You now scan the lock file from its end backwards to find your claim message. Its offset is now your
    unique claim id. You also find the preceding lock interest message (if any), and the subsequent lock
    interest message (if any). You now append an "This is how my claim relates to this preceding and
    subsequent claims" message. You now scan the lock file from its end backwards again to find your
    newly posted claim relation message.

    3. By reordering the claim relation messages based on their unique claim id, you have a priority queue.
    Let us imagine the combinations that two writers 1 happens before 2 could append:
      a. Interest(1)          Interest(1)          Interest(1)
      b. Relation(1, 0, 0)    Interest(2)          Interest(2)
      c. Interest(2)          Relation(1, 0, 2)    Relation(2, 1, 0)
      d. Relation(2, 1, 0)    Relation(2, 1, 0)    Relation(1, 0, 2)
    Clearly, if your claim relation message shows no preceding claim, you now have the mutex. You indicate
    this by posting a "I have the mutex" message.

    4. If your claim relation message does show a preceding claim, you now spin on scanning the lock file from
    the unique claim id with the mutex to the end of the lock file. When the holder of the mutex is finished,
    they unlock by scanning the lock file from its unique claim id to the end of the lock file looking for the
    next unique claim id without a rescind message, and they post an unlock message with the unique claim id
    of the next claim. After posting the unlock message, they scan the lock file from its end backwards to find
    the unlock message just posted and if the writer they just handed the mutex to has rescinded their interest,
    they nominate the next writer in the priority queue and so on until a nominated writer issues a "I have the
    mutex" message. At this point, the newly released writer may examine the lock file extents to see if it's
    worth zeroing the lock file up to the point of the just released unique claim id.

    5. For efficiency, all those interested in the lock can rescind their interest with a rescind message.
    If a process with interest dies without rescinding it, one is allowed to ignore interest messages once
    their most recent claim relation message becomes older than twenty seconds. For this reason, those interested
    in the lock, or those holding the mutex, should reissue their claim relation or mutex ownership message
    every fifteen seconds with an updated timestamp.

    */</span>
    <span class="keyword">if</span><span class="special">(</span><span class="number">1</span><span class="special">)</span>
    <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\nBenchmarking file locks via atomic append with "</span> <span class="special">&lt;&lt;</span> <span class="identifier">writers</span> <span class="special">&lt;&lt;</span> <span class="string">" concurrent writers ...\n"</span><span class="special">;</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">thread</span><span class="special">&gt;</span> <span class="identifier">threads</span><span class="special">;</span>
      <span class="identifier">atomic</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">&gt;</span> <span class="identifier">done</span><span class="special">(</span><span class="keyword">true</span><span class="special">);</span>
      <span class="identifier">atomic</span><span class="special">&lt;</span><span class="identifier">size_t</span><span class="special">&gt;</span> <span class="identifier">attempts</span><span class="special">(</span><span class="number">0</span><span class="special">),</span> <span class="identifier">successes</span><span class="special">(</span><span class="number">0</span><span class="special">);</span>
      <span class="keyword">for</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">thread</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">thread</span><span class="special">&lt;</span><span class="identifier">writers</span><span class="special">;</span> <span class="identifier">thread</span><span class="special">++)</span>
      <span class="special">{</span>
        <span class="identifier">threads</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">thread</span><span class="special">([&amp;</span><span class="identifier">done</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">attempts</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">successes</span><span class="special">,</span> <span class="identifier">thread</span><span class="special">]{</span>
          <span class="keyword">try</span>
          <span class="special">{</span>
            <span class="comment">// Create a dispatcher</span>
            <span class="keyword">auto</span> <span class="identifier">dispatcher</span> <span class="special">=</span> <span class="identifier">make_async_file_io_dispatcher</span><span class="special">();</span>
            <span class="comment">// Schedule opening the log file for writing log entries</span>
            <span class="keyword">auto</span> <span class="identifier">logfile</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"testdir/log"</span><span class="special">,</span>
                <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Create</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">ReadWrite</span><span class="special">)));</span>
            <span class="comment">// Schedule opening the lock file for scanning and hole punching</span>
            <span class="keyword">auto</span> <span class="identifier">lockfilez</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"testdir/log.lock"</span><span class="special">,</span>
                <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Create</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">ReadWrite</span><span class="special">)));</span>
            <span class="comment">// Schedule opening the lock file for atomic appending</span>
            <span class="keyword">auto</span> <span class="identifier">lockfilea</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"testdir/log.lock"</span><span class="special">,</span>
                <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Create</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Write</span> <span class="special">|</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Append</span><span class="special">)));</span>
            <span class="comment">// Retrieve any errors which occurred</span>
            <span class="identifier">lockfilea</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span> <span class="identifier">lockfilez</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span> <span class="identifier">logfile</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
            <span class="keyword">while</span><span class="special">(!</span><span class="identifier">done</span><span class="special">)</span>
            <span class="special">{</span>
              <span class="comment">// Each lock log entry is 16 bytes in length.</span>
              <span class="keyword">enum</span> <span class="keyword">class</span> <span class="identifier">message_code_t</span> <span class="special">:</span> <span class="identifier">uint8_t</span>
              <span class="special">{</span>
                <span class="identifier">unlock</span><span class="special">=</span><span class="number">0</span><span class="special">,</span>
                <span class="identifier">havelock</span><span class="special">=</span><span class="number">1</span><span class="special">,</span>
                <span class="identifier">rescind</span><span class="special">=</span><span class="number">2</span><span class="special">,</span>
                <span class="identifier">interest</span><span class="special">=</span><span class="number">3</span><span class="special">,</span>
                <span class="identifier">nominate</span><span class="special">=</span><span class="number">5</span>
              <span class="special">};</span>
<span class="preprocessor">#pragma</span> <span class="identifier">pack</span><span class="special">(</span><span class="identifier">push</span><span class="special">,</span> <span class="number">1</span><span class="special">)</span>
              <span class="keyword">union</span> <span class="identifier">message_t</span>
              <span class="special">{</span>
                <span class="keyword">char</span> <span class="identifier">bytes</span><span class="special">[</span><span class="number">16</span><span class="special">];</span>
                <span class="keyword">struct</span>
                <span class="special">{</span>
                  <span class="identifier">message_code_t</span> <span class="identifier">code</span><span class="special">;</span>
                  <span class="keyword">char</span> <span class="identifier">__padding1</span><span class="special">[</span><span class="number">3</span><span class="special">];</span>
                  <span class="identifier">uint32_t</span> <span class="identifier">timestamp</span><span class="special">;</span> <span class="comment">// time_t</span>
                  <span class="identifier">uint64_t</span> <span class="identifier">uniqueid</span><span class="special">;</span>
                <span class="special">};</span>
              <span class="special">};</span>
<span class="preprocessor">#pragma</span> <span class="identifier">pack</span><span class="special">(</span><span class="identifier">pop</span><span class="special">)</span>
              <span class="keyword">static_assert</span><span class="special">(</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">message_t</span><span class="special">)==</span><span class="number">16</span><span class="special">,</span> <span class="string">"message_t is not 16 bytes long!"</span><span class="special">);</span>
              <span class="keyword">auto</span> <span class="identifier">gettime</span><span class="special">=[]{</span> <span class="keyword">return</span> <span class="special">(</span><span class="identifier">uint32_t</span><span class="special">)(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">time</span><span class="special">(</span><span class="keyword">nullptr</span><span class="special">)-</span><span class="number">1420070400UL</span><span class="comment">/* 1st Jan 2015*/</span><span class="special">);</span> <span class="special">};</span>
              <span class="identifier">message_t</span> <span class="identifier">temp</span><span class="special">,</span> <span class="identifier">buffers</span><span class="special">[</span><span class="number">256</span><span class="special">];</span>
              <span class="identifier">off_t</span> <span class="identifier">buffersoffset</span><span class="special">;</span>
              <span class="identifier">uint32_t</span> <span class="identifier">nowtimestamp</span><span class="special">=</span><span class="identifier">gettime</span><span class="special">();</span>
              <span class="comment">// TODO FIXME: If multiple machines are all accessing the lock file, nowtimestamp</span>
              <span class="comment">//             ought to be corrected for drift</span>

              <span class="comment">// Step 1: Register my interest</span>
              <span class="identifier">memset</span><span class="special">(</span><span class="identifier">temp</span><span class="special">.</span><span class="identifier">bytes</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">temp</span><span class="special">));</span>
              <span class="identifier">temp</span><span class="special">.</span><span class="identifier">code</span><span class="special">=</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">interest</span><span class="special">;</span>
              <span class="identifier">temp</span><span class="special">.</span><span class="identifier">timestamp</span><span class="special">=</span><span class="identifier">nowtimestamp</span><span class="special">;</span>
              <span class="identifier">temp</span><span class="special">.</span><span class="identifier">uniqueid</span><span class="special">=</span><span class="identifier">thread</span><span class="special">;</span> <span class="comment">// TODO FIXME: Needs to be a VERY random number to prevent collision.</span>
              <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">write</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">lockfilea</span><span class="special">,</span> <span class="identifier">temp</span><span class="special">.</span><span class="identifier">bytes</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">temp</span><span class="special">),</span> <span class="number">0</span><span class="special">)).</span><span class="identifier">get</span><span class="special">();</span>

              <span class="comment">// Step 2: Wait until my interest message appears, also figure out what interests precede</span>
              <span class="comment">//         mine and where my start of interest begins, and if someone currently has the lock</span>
              <span class="identifier">off_t</span> <span class="identifier">startofinterest</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">extents</span><span class="special">(</span><span class="identifier">lockfilez</span><span class="special">).</span><span class="identifier">first</span><span class="special">.</span><span class="identifier">get</span><span class="special">().</span><span class="identifier">front</span><span class="special">().</span><span class="identifier">first</span><span class="special">;</span>
              <span class="identifier">off_t</span> <span class="identifier">myuniqueid</span><span class="special">=(</span><span class="identifier">off_t</span><span class="special">)-</span><span class="number">1</span><span class="special">;</span>
              <span class="keyword">bool</span> <span class="identifier">findPreceding</span><span class="special">=</span><span class="keyword">true</span><span class="special">;</span>
              <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">off_t</span><span class="special">&gt;&gt;</span> <span class="identifier">preceding</span><span class="special">;</span>
              <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">off_t</span><span class="special">&gt;</span> <span class="identifier">lockid</span><span class="special">;</span>
              <span class="keyword">auto</span> <span class="identifier">iterate</span><span class="special">=[&amp;]{</span>
                <span class="identifier">size_t</span> <span class="identifier">validPrecedingCount</span><span class="special">=</span><span class="number">0</span><span class="special">;</span>
                <span class="identifier">off_t</span> <span class="identifier">lockfilesize</span><span class="special">=</span><span class="identifier">lockfilez</span><span class="special">-&gt;</span><span class="identifier">lstat</span><span class="special">(</span><span class="identifier">metadata_flags</span><span class="special">::</span><span class="identifier">size</span><span class="special">).</span><span class="identifier">st_size</span><span class="special">;</span>
                <span class="identifier">buffersoffset</span><span class="special">=</span><span class="identifier">lockfilesize</span><span class="special">&gt;</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">)</span> <span class="special">?</span> <span class="identifier">lockfilesize</span><span class="special">-</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">)</span> <span class="special">:</span> <span class="number">0</span><span class="special">;</span>
                <span class="comment">//buffersoffset-=buffersoffset % sizeof(buffers[0]);</span>
                <span class="keyword">for</span><span class="special">(;</span> <span class="special">!</span><span class="identifier">validPrecedingCount</span> <span class="special">&amp;&amp;</span> <span class="identifier">buffersoffset</span><span class="special">&gt;=</span><span class="identifier">startofinterest</span> <span class="special">&amp;&amp;</span> <span class="identifier">buffersoffset</span><span class="special">&lt;</span><span class="identifier">lockfilesize</span><span class="special">;</span> <span class="identifier">buffersoffset</span><span class="special">-=</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">))</span>
                <span class="special">{</span>
                  <span class="identifier">size_t</span> <span class="identifier">amount</span><span class="special">=(</span><span class="identifier">size_t</span><span class="special">)(</span><span class="identifier">lockfilesize</span><span class="special">-</span><span class="identifier">buffersoffset</span><span class="special">);</span>
                  <span class="keyword">if</span><span class="special">(</span><span class="identifier">amount</span><span class="special">&gt;</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">))</span>
                    <span class="identifier">amount</span><span class="special">=</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">);</span>
                  <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">read</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">lockfilez</span><span class="special">,</span> <span class="special">(</span><span class="keyword">void</span> <span class="special">*)</span> <span class="identifier">buffers</span><span class="special">,</span> <span class="identifier">amount</span><span class="special">,</span> <span class="identifier">buffersoffset</span><span class="special">)).</span><span class="identifier">get</span><span class="special">();</span>
                  <span class="keyword">for</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">n</span><span class="special">=</span><span class="identifier">amount</span><span class="special">/</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">])-</span><span class="number">1</span><span class="special">;</span> <span class="special">!</span><span class="identifier">validPrecedingCount</span> <span class="special">&amp;&amp;</span> <span class="identifier">n</span><span class="special">&lt;</span><span class="identifier">amount</span><span class="special">/</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">]);</span> <span class="identifier">n</span><span class="special">--)</span>
                  <span class="special">{</span>
                    <span class="comment">// Early exit if messages have become stale</span>
                    <span class="keyword">if</span><span class="special">(!</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">timestamp</span> <span class="special">||</span> <span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">timestamp</span><span class="special">&lt;</span><span class="identifier">nowtimestamp</span> <span class="special">&amp;&amp;</span> <span class="identifier">nowtimestamp</span><span class="special">-</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">timestamp</span><span class="special">&gt;</span><span class="number">20</span><span class="special">))</span>
                    <span class="special">{</span>
                      <span class="identifier">startofinterest</span><span class="special">=</span><span class="identifier">buffersoffset</span><span class="special">+</span><span class="identifier">n</span><span class="special">*</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">]);</span>
                      <span class="keyword">break</span><span class="special">;</span>
                    <span class="special">}</span>
                    <span class="comment">// Find if he is locked or unlocked</span>
                    <span class="keyword">if</span><span class="special">(</span><span class="identifier">lockid</span><span class="special">.</span><span class="identifier">second</span><span class="special">==(</span><span class="identifier">off_t</span><span class="special">)</span> <span class="special">-</span><span class="number">1</span><span class="special">)</span>
                      <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">unlock</span><span class="special">)</span>
                        <span class="identifier">lockid</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">);</span>
                      <span class="keyword">else</span> <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">havelock</span><span class="special">)</span>
                        <span class="identifier">lockid</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">);</span>
                    <span class="comment">// Am I searching for my interest?</span>
                    <span class="keyword">if</span><span class="special">(</span><span class="identifier">myuniqueid</span><span class="special">==(</span><span class="identifier">off_t</span><span class="special">)-</span><span class="number">1</span><span class="special">)</span>
                    <span class="special">{</span>
                      <span class="keyword">if</span><span class="special">(!</span><span class="identifier">memcmp</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">+</span><span class="identifier">n</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">temp</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">temp</span><span class="special">)))</span>
                        <span class="identifier">myuniqueid</span><span class="special">=</span><span class="identifier">buffersoffset</span><span class="special">+</span><span class="identifier">n</span><span class="special">*</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">]);</span>
                    <span class="special">}</span>
                    <span class="keyword">else</span> <span class="keyword">if</span><span class="special">(</span><span class="identifier">findPreceding</span> <span class="special">&amp;&amp;</span> <span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">&lt;</span><span class="identifier">myuniqueid</span> <span class="special">||</span> <span class="identifier">buffersoffset</span><span class="special">+</span><span class="identifier">n</span><span class="special">*</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">])&lt;</span><span class="identifier">myuniqueid</span><span class="special">))</span>
                    <span class="special">{</span>
                      <span class="comment">// We are searching for preceding claims now</span>
                      <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">rescind</span> <span class="special">||</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">unlock</span><span class="special">)</span>
                        <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">));</span>
                      <span class="keyword">else</span> <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">nominate</span> <span class="special">||</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">havelock</span><span class="special">)</span>
                      <span class="special">{</span>
                        <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">&lt;</span><span class="identifier">myuniqueid</span> <span class="special">&amp;&amp;</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">()==</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">preceding</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span> <span class="special">(</span><span class="identifier">off_t</span><span class="special">)</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">)))</span>
                        <span class="special">{</span>
                          <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">uniqueid</span><span class="special">));</span>
                          <span class="identifier">validPrecedingCount</span><span class="special">++;</span>
                        <span class="special">}</span>
                      <span class="special">}</span>
                      <span class="keyword">else</span> <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="identifier">n</span><span class="special">].</span><span class="identifier">code</span><span class="special">==</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">interest</span><span class="special">)</span>
                      <span class="special">{</span>
                        <span class="keyword">if</span><span class="special">(</span><span class="identifier">buffersoffset</span><span class="special">+</span><span class="identifier">n</span><span class="special">*</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">])&lt;</span><span class="identifier">myuniqueid</span> <span class="special">&amp;&amp;</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">()==</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">preceding</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span> <span class="identifier">buffersoffset</span><span class="special">+</span><span class="identifier">n</span><span class="special">*</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">]))))</span>
                        <span class="special">{</span>
                          <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">buffersoffset</span><span class="special">+</span><span class="identifier">n</span><span class="special">*</span><span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">buffers</span><span class="special">[</span><span class="number">0</span><span class="special">])));</span>
                          <span class="identifier">validPrecedingCount</span><span class="special">++;</span>
                        <span class="special">}</span>
                      <span class="special">}</span>
                    <span class="special">}</span>
                  <span class="special">}</span>
                <span class="special">}</span>
<span class="preprocessor">#if</span> <span class="number">0</span>
                <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">thread</span> <span class="special">&lt;&lt;</span> <span class="string">": myuniqueid="</span> <span class="special">&lt;&lt;</span> <span class="identifier">myuniqueid</span> <span class="special">&lt;&lt;</span> <span class="string">" startofinterest="</span> <span class="special">&lt;&lt;</span> <span class="identifier">startofinterest</span> <span class="special">&lt;&lt;</span> <span class="string">" size="</span> <span class="special">&lt;&lt;</span> <span class="identifier">lockfilez</span><span class="special">-&gt;</span><span class="identifier">lstat</span><span class="special">(</span><span class="identifier">metadata_flags</span><span class="special">::</span><span class="identifier">size</span><span class="special">).</span><span class="identifier">st_size</span> <span class="special">&lt;&lt;</span> <span class="string">" lockid="</span> <span class="special">&lt;&lt;</span> <span class="identifier">lockid</span><span class="special">.</span><span class="identifier">first</span> <span class="special">&lt;&lt;</span> <span class="string">","</span> <span class="special">&lt;&lt;</span> <span class="identifier">lockid</span><span class="special">.</span><span class="identifier">second</span> <span class="special">&lt;&lt;</span> <span class="string">" preceding="</span><span class="special">;</span>
                <span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">i</span> <span class="special">:</span> <span class="identifier">preceding</span><span class="special">)</span>
                  <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span><span class="special">.</span><span class="identifier">first</span> <span class="special">&lt;&lt;</span> <span class="string">","</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span><span class="special">.</span><span class="identifier">second</span> <span class="special">&lt;&lt;</span> <span class="string">";"</span><span class="special">;</span>
                <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="preprocessor">#endif</span>
                <span class="keyword">if</span><span class="special">(</span><span class="identifier">findPreceding</span><span class="special">)</span>
                <span class="special">{</span>
                  <span class="comment">// Remove all rescinded interests preceding ours</span>
                  <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">erase</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">remove_if</span><span class="special">(</span><span class="identifier">preceding</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="special">[](</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">off_t</span><span class="special">&gt;</span> <span class="special">&amp;</span><span class="identifier">i</span><span class="special">){</span> <span class="keyword">return</span> <span class="special">!</span><span class="identifier">i</span><span class="special">.</span><span class="identifier">first</span><span class="special">;</span> <span class="special">}),</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">());</span>
                  <span class="identifier">std</span><span class="special">::</span><span class="identifier">sort</span><span class="special">(</span><span class="identifier">preceding</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">end</span><span class="special">());</span>
                  <span class="identifier">findPreceding</span><span class="special">=</span><span class="keyword">false</span><span class="special">;</span>
                <span class="special">}</span>
              <span class="special">};</span>
              <span class="keyword">do</span>
              <span class="special">{</span>
                <span class="identifier">lockid</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span> <span class="special">(</span><span class="identifier">off_t</span><span class="special">)-</span><span class="number">1</span><span class="special">);</span>
                <span class="identifier">iterate</span><span class="special">();</span>
                <span class="comment">// Didn't find it, so sleep and retry, maybe st_size will have updated by then</span>
                <span class="keyword">if</span><span class="special">(</span><span class="identifier">myuniqueid</span><span class="special">==(</span><span class="identifier">off_t</span><span class="special">)-</span><span class="number">1</span><span class="special">)</span> <span class="identifier">this_thread</span><span class="special">::</span><span class="identifier">sleep_for</span><span class="special">(</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">milliseconds</span><span class="special">(</span><span class="number">1</span><span class="special">));</span>
              <span class="special">}</span> <span class="keyword">while</span><span class="special">(</span><span class="identifier">myuniqueid</span><span class="special">==(</span><span class="identifier">off_t</span><span class="special">)-</span><span class="number">1</span><span class="special">);</span>

              <span class="comment">// Step 3: If there is no lock and no interest precedes mine, claim the mutex. Else issue a nominate for myself,</span>
              <span class="comment">//         once per ten seconds.</span>
              <span class="special">{</span>
                <span class="identifier">nowtimestamp</span><span class="special">=</span><span class="number">0</span><span class="special">;</span>
                <span class="identifier">mutex</span> <span class="identifier">m</span><span class="special">;</span>
                <span class="identifier">condition_variable</span> <span class="identifier">c</span><span class="special">;</span>
                <span class="identifier">unique_lock</span><span class="special">&lt;</span><span class="keyword">decltype</span><span class="special">(</span><span class="identifier">m</span><span class="special">)&gt;</span> <span class="identifier">l</span><span class="special">(</span><span class="identifier">m</span><span class="special">);</span>
                <span class="identifier">atomic</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">&gt;</span> <span class="identifier">fileChanged</span><span class="special">(</span><span class="keyword">false</span><span class="special">);</span>
                <span class="keyword">for</span><span class="special">(;;)</span>
                <span class="special">{</span>
                  <span class="identifier">attempts</span><span class="special">.</span><span class="identifier">fetch_add</span><span class="special">(</span><span class="number">1</span><span class="special">,</span> <span class="identifier">memory_order_relaxed</span><span class="special">);</span>
                  <span class="identifier">temp</span><span class="special">.</span><span class="identifier">timestamp</span><span class="special">=</span><span class="identifier">gettime</span><span class="special">();</span>
                  <span class="identifier">temp</span><span class="special">.</span><span class="identifier">uniqueid</span><span class="special">=</span><span class="identifier">myuniqueid</span><span class="special">;</span>
                  <span class="keyword">if</span><span class="special">(</span><span class="identifier">preceding</span><span class="special">.</span><span class="identifier">empty</span><span class="special">())</span>
                  <span class="special">{</span>
                    <span class="identifier">temp</span><span class="special">.</span><span class="identifier">code</span><span class="special">=</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">havelock</span><span class="special">;</span>
                    <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">write</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">lockfilea</span><span class="special">,</span> <span class="identifier">temp</span><span class="special">.</span><span class="identifier">bytes</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">temp</span><span class="special">),</span> <span class="number">0</span><span class="special">)).</span><span class="identifier">get</span><span class="special">();</span>
                    <span class="comment">// Zero the range between startofinterest and myuniqueid</span>
                    <span class="keyword">if</span><span class="special">(</span><span class="identifier">startofinterest</span><span class="special">&lt;</span><span class="identifier">myuniqueid</span><span class="special">)</span>
                    <span class="special">{</span>
                      <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">off_t</span><span class="special">,</span> <span class="identifier">off_t</span><span class="special">&gt;&gt;</span> <span class="identifier">range</span><span class="special">={{</span><span class="identifier">startofinterest</span><span class="special">,</span> <span class="identifier">myuniqueid</span><span class="special">-</span><span class="identifier">startofinterest</span><span class="special">}};</span>
                      <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">zero</span><span class="special">(</span><span class="identifier">lockfilez</span><span class="special">,</span> <span class="identifier">range</span><span class="special">).</span><span class="identifier">get</span><span class="special">();</span>
  <span class="comment">//                    std::cout &lt;&lt; thread &lt;&lt; ": lock taken for myuniqueid=" &lt;&lt; myuniqueid &lt;&lt; ", zeroing " &lt;&lt; range.front().first &lt;&lt; ", " &lt;&lt; range.front().second &lt;&lt; std::endl;</span>
                    <span class="special">}</span>
                    <span class="keyword">break</span><span class="special">;</span>
                  <span class="special">}</span>
                  <span class="keyword">else</span>
                  <span class="special">{</span>
                    <span class="keyword">auto</span> <span class="identifier">lockfilechanged</span><span class="special">=[&amp;]{</span>
                      <span class="identifier">fileChanged</span><span class="special">=</span><span class="keyword">true</span><span class="special">;</span>
                      <span class="identifier">c</span><span class="special">.</span><span class="identifier">notify_all</span><span class="special">();</span>
                    <span class="special">};</span>
                    <span class="comment">// TODO FIXME: Put a modify watch on the lockfile instead of spinning</span>
                    <span class="keyword">if</span><span class="special">(</span><span class="identifier">temp</span><span class="special">.</span><span class="identifier">timestamp</span><span class="special">-</span><span class="identifier">nowtimestamp</span><span class="special">&gt;=</span><span class="number">10</span><span class="special">)</span>
                    <span class="special">{</span>
                      <span class="identifier">temp</span><span class="special">.</span><span class="identifier">code</span><span class="special">=</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">nominate</span><span class="special">;</span>
                      <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">write</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">lockfilea</span><span class="special">,</span> <span class="identifier">temp</span><span class="special">.</span><span class="identifier">bytes</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">temp</span><span class="special">),</span> <span class="number">0</span><span class="special">)).</span><span class="identifier">get</span><span class="special">();</span>
                      <span class="identifier">nowtimestamp</span><span class="special">=</span><span class="identifier">temp</span><span class="special">.</span><span class="identifier">timestamp</span><span class="special">;</span>
                    <span class="special">}</span>
                    <span class="comment">//c.wait_for(l, chrono::milliseconds(1), [&amp;fileChanged]{ return fileChanged==true; });</span>
                    <span class="identifier">fileChanged</span><span class="special">=</span><span class="keyword">false</span><span class="special">;</span>
                    <span class="identifier">preceding</span><span class="special">.</span><span class="identifier">clear</span><span class="special">();</span>
                    <span class="identifier">findPreceding</span><span class="special">=</span><span class="keyword">true</span><span class="special">;</span>
                    <span class="identifier">lockid</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span> <span class="special">(</span><span class="identifier">off_t</span><span class="special">)-</span><span class="number">1</span><span class="special">);</span>
                    <span class="identifier">iterate</span><span class="special">();</span>
                  <span class="special">}</span>
                <span class="special">}</span>
              <span class="special">}</span>

              <span class="comment">// Step 4: I now have the lock, so do my thing</span>
              <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">logentry</span><span class="special">(</span><span class="string">"I am log writer "</span><span class="special">),</span> <span class="identifier">mythreadid</span><span class="special">(</span><span class="identifier">to_string</span><span class="special">(</span><span class="identifier">thread</span><span class="special">)),</span> <span class="identifier">logentryend</span><span class="special">(</span><span class="string">"!\n"</span><span class="special">);</span>
              <span class="comment">// Fetch the size</span>
              <span class="identifier">off_t</span> <span class="identifier">where</span><span class="special">=</span><span class="identifier">logfile</span><span class="special">-&gt;</span><span class="identifier">lstat</span><span class="special">().</span><span class="identifier">st_size</span><span class="special">,</span> <span class="identifier">entrysize</span><span class="special">=</span><span class="identifier">logentry</span><span class="special">.</span><span class="identifier">size</span><span class="special">()+</span><span class="identifier">mythreadid</span><span class="special">.</span><span class="identifier">size</span><span class="special">()+</span><span class="identifier">logentryend</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span>
              <span class="comment">// Schedule extending the log file</span>
              <span class="keyword">auto</span> <span class="identifier">extendlog</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">truncate</span><span class="special">(</span><span class="identifier">logfile</span><span class="special">,</span> <span class="identifier">where</span><span class="special">+</span><span class="identifier">entrysize</span><span class="special">));</span>
              <span class="comment">// Schedule writing the new entry</span>
              <span class="keyword">auto</span> <span class="identifier">writetolog</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">write</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">extendlog</span><span class="special">,</span> <span class="special">{</span><span class="identifier">logentry</span><span class="special">,</span> <span class="identifier">mythreadid</span><span class="special">,</span> <span class="identifier">logentryend</span><span class="special">},</span> <span class="identifier">where</span><span class="special">)));</span>
              <span class="comment">// Fetch errors from the last operation first to avoid sleep-wake cycling</span>
              <span class="identifier">writetolog</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
              <span class="identifier">extendlog</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
              <span class="identifier">successes</span><span class="special">.</span><span class="identifier">fetch_add</span><span class="special">(</span><span class="number">1</span><span class="special">,</span> <span class="identifier">memory_order_relaxed</span><span class="special">);</span>
<span class="comment">//              std::cout &lt;&lt; thread &lt;&lt; ": doing work for myuniqueid=" &lt;&lt; myuniqueid &lt;&lt; std::endl;</span>
<span class="comment">//              this_thread::sleep_for(chrono::milliseconds(250));</span>

              <span class="comment">// Step 5: Release the lock</span>
              <span class="identifier">temp</span><span class="special">.</span><span class="identifier">code</span><span class="special">=</span><span class="identifier">message_code_t</span><span class="special">::</span><span class="identifier">unlock</span><span class="special">;</span>
              <span class="identifier">temp</span><span class="special">.</span><span class="identifier">timestamp</span><span class="special">=</span><span class="identifier">gettime</span><span class="special">();</span>
              <span class="identifier">temp</span><span class="special">.</span><span class="identifier">uniqueid</span><span class="special">=</span><span class="identifier">myuniqueid</span><span class="special">;</span>
<span class="comment">//              std::cout &lt;&lt; thread &lt;&lt; ": lock released for myuniqueid=" &lt;&lt; myuniqueid &lt;&lt; std::endl;</span>
              <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">write</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">lockfilea</span><span class="special">,</span> <span class="identifier">temp</span><span class="special">.</span><span class="identifier">bytes</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">temp</span><span class="special">),</span> <span class="number">0</span><span class="special">)).</span><span class="identifier">get</span><span class="special">();</span>
            <span class="special">}</span>
          <span class="special">}</span>
          <span class="keyword">catch</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">system_error</span> <span class="special">&amp;</span><span class="identifier">e</span><span class="special">)</span> <span class="special">{</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: test exits via system_error code "</span> <span class="special">&lt;&lt;</span> <span class="identifier">e</span><span class="special">.</span><span class="identifier">code</span><span class="special">().</span><span class="identifier">value</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">"("</span> <span class="special">&lt;&lt;</span> <span class="identifier">e</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">")"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="identifier">abort</span><span class="special">();</span> <span class="special">}</span>
          <span class="keyword">catch</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span> <span class="special">&amp;</span><span class="identifier">e</span><span class="special">)</span> <span class="special">{</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: test exits via exception ("</span> <span class="special">&lt;&lt;</span> <span class="identifier">e</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">")"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="identifier">abort</span><span class="special">();</span> <span class="special">}</span>
          <span class="keyword">catch</span><span class="special">(...)</span> <span class="special">{</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: test exits via unknown exception"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span> <span class="identifier">abort</span><span class="special">();</span> <span class="special">}</span>
        <span class="special">}));</span>
      <span class="special">}</span>
      <span class="keyword">auto</span> <span class="identifier">begin</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
      <span class="identifier">done</span><span class="special">=</span><span class="keyword">false</span><span class="special">;</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">this_thread</span><span class="special">::</span><span class="identifier">sleep_for</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">seconds</span><span class="special">(</span><span class="number">20</span><span class="special">));</span>
      <span class="identifier">done</span><span class="special">=</span><span class="keyword">true</span><span class="special">;</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Waiting for threads to exit ..."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
      <span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">i</span> <span class="special">:</span> <span class="identifier">threads</span><span class="special">)</span>
        <span class="identifier">i</span><span class="special">.</span><span class="identifier">join</span><span class="special">();</span>
      <span class="keyword">auto</span> <span class="identifier">end</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
      <span class="keyword">auto</span> <span class="identifier">diff</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration_cast</span><span class="special">&lt;</span><span class="identifier">secs_type</span><span class="special">&gt;(</span><span class="identifier">end</span><span class="special">-</span><span class="identifier">begin</span><span class="special">);</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"For "</span> <span class="special">&lt;&lt;</span> <span class="identifier">writers</span> <span class="special">&lt;&lt;</span> <span class="string">" concurrent writers, achieved "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">attempts</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">())</span> <span class="special">&lt;&lt;</span> <span class="string">" attempts per second with a "</span>
      <span class="string">"success rate of "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">successes</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">())</span> <span class="special">&lt;&lt;</span> <span class="string">" writes per second which is a "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="number">100.0</span><span class="special">*</span><span class="identifier">successes</span><span class="special">/</span><span class="identifier">attempts</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">"% success rate."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
      <span class="identifier">atomic_log_locks</span><span class="special">=</span><span class="identifier">successes</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">();</span>
    <span class="special">}</span>
    <span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">remove_all</span><span class="special">(</span><span class="string">"testdir"</span><span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Traditional locks were "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">traditional_locks</span><span class="special">/</span><span class="identifier">atomic_log_locks</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">" times faster."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
<span class="special">}</span>
</pre>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2013-2015 Niall Douglas
      and Paul Kirth<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="file_concat.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../afio.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="so_what.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
