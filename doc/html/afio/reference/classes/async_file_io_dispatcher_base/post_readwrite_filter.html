<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>post_readwrite_filter</title>
<link rel="stylesheet" href="../../../../../../libs/afio/doc/html/myboostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.76.1">
<link rel="home" href="../../../../afio.html" title="Chapter&#160;1.&#160;Boost.AFIO 1.2">
<link rel="up" href="../async_file_io_dispatcher_base.html" title="async_file_io_dispatcher_base">
<link rel="prev" href="post_op_filter.html" title="post_op_filter">
<link rel="next" href="completion_2_batch_bound_functions.html" title="completion (batch bound functions)">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="post_op_filter.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io_dispatcher_base.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../../afio.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="completion_2_batch_bound_functions.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h5 class="title">
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter"></a><a class="link" href="post_readwrite_filter.html" title="post_readwrite_filter">post_readwrite_filter</a>
</h5></div></div></div>
<p>
            <a class="indexterm" name="idp13457968"></a>
Install read/write op filters, useful for tight ASIO integration. Not
            threadsafe.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.h0"></a>
            <span><a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.description"></a></span><a class="link" href="post_readwrite_filter.html#afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.description">Description</a>
          </h6>
<p>
            <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">async</span><span class="special">\</span><span class="identifier">u005ffile</span><span class="special">\</span><span class="identifier">u005fio</span><span class="special">\</span><span class="identifier">u005fdispatcher</span><span class="special">\</span><span class="identifier">u005fbase</span><span class="special">::</span><span class="identifier">filter</span><span class="special">\</span><span class="identifier">u005fbuffers</span><span class="special">\</span><span class="identifier">u005ft</span><span class="special">&gt;</span></code>
            will be called after every op of type <code class="computeroutput"><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span></code>
            completes (<code class="computeroutput"><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span><span class="special">::</span><span class="identifier">Unknown</span></code> means call this filter for
            all ops) with the op type, file handle, op input, file offset, buffers
            offset, buffers amount, error state and bytes transferred. Any filter
            other than read() and write() will be ignored, for those use post_op_filter().
          </p>
<p>
            Note that buffer filters are currently implemented as a linear scan,
            so a full iteration of all buffer filters is done for every read/write
            op completed. The filter is called straight after a read or write operation
            has completed, and BEFORE any checks that it transferred the data it
            was supposed to. Any exceptions thrown by the filter are reported as
            if the read/write operation threw them, and filter processing stops at
            the filter which threw.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.h1"></a>
            <span><a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.synopsis"></a></span><a class="link" href="post_readwrite_filter.html#afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.synopsis">Synopsis</a>
          </h6>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">post_readwrite_filter</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span> <span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span> <span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">filter_readwrite_t</span> <span class="special">&gt;&gt;&gt;</span> <span class="identifier">filters</span><span class="special">)</span></pre>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.h2"></a>
            <span><a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.parameters"></a></span><a class="link" href="post_readwrite_filter.html#afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.parameters">Parameters</a>
          </h6>
<div class="informaltable"><table class="table">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                    <p>
                      Type
                    </p>
                  </th>
<th>
                    <p>
                      Concept
                    </p>
                  </th>
<th>
                    <p>
                      Name
                    </p>
                  </th>
<th>
                    <p>
                      Description
                    </p>
                  </th>
</tr></thead>
<tbody><tr>
<td>
                    <p>
                      std::vector&lt; std::pair&lt; detail::OpType, std::function&lt;
                      async_file_io_dispatcher_base::filter_readwrite_t &gt;&gt;&gt;
                    </p>
                  </td>
<td>
                  </td>
<td>
                    <p>
                      filters
                    </p>
                  </td>
<td>
                    <p>
                      A batch of pairs of op type to be filtered and bound filter
                      handler functions of type <code class="computeroutput"><span class="identifier">filter_buffers_t</span></code>
                    </p>
                  </td>
</tr></tbody>
</table></div>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.h3"></a>
            <span><a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.header"></a></span><a class="link" href="post_readwrite_filter.html#afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.header">Header</a>
          </h6>
<p>
            <code class="computeroutput"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">afio</span><span class="special">/</span><span class="identifier">afio</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span></code>
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.h4"></a>
            <span><a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.complexity"></a></span><a class="link" href="post_readwrite_filter.html#afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.complexity">Complexity</a>
          </h6>
<p>
            O(N) where N is the total number of filters currently configured.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.h5"></a>
            <span><a name="afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.example"></a></span><a class="link" href="post_readwrite_filter.html#afio.reference.classes.async_file_io_dispatcher_base.post_readwrite_filter.example">Example</a>
          </h6>
<pre class="programlisting"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">;</span>

<span class="comment">// This function will be called for every file opened</span>
<span class="keyword">static</span> <span class="keyword">void</span> <span class="identifier">open_file_filter</span><span class="special">(</span><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span><span class="special">,</span> <span class="identifier">async_io_op</span> <span class="special">&amp;</span><span class="identifier">op</span><span class="special">)</span> <span class="identifier">BOOST_NOEXCEPT</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"File handle "</span> <span class="special">&lt;&lt;</span> <span class="identifier">op</span><span class="special">.</span><span class="identifier">get</span><span class="special">()-&gt;</span><span class="identifier">native_handle</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" opened!"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>

<span class="comment">// This function will be called for every read and write performed</span>
<span class="keyword">static</span> <span class="keyword">void</span> <span class="identifier">readwrite_filter</span><span class="special">(</span><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span> <span class="identifier">optype</span><span class="special">,</span> <span class="identifier">async_io_handle</span> <span class="special">*</span><span class="identifier">h</span><span class="special">,</span>
    <span class="keyword">const</span> <span class="identifier">detail</span><span class="special">::</span><span class="identifier">async_data_op_req_impl</span><span class="special">&lt;</span><span class="keyword">true</span><span class="special">&gt;</span> <span class="special">&amp;</span><span class="identifier">req</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">off_t</span> <span class="identifier">offset</span><span class="special">,</span> <span class="identifier">size_t</span> <span class="identifier">buffer_idx</span><span class="special">,</span>
    <span class="identifier">size_t</span> <span class="identifier">buffers</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="special">&amp;</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">size_t</span> <span class="identifier">bytes_transferred</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"File handle "</span> <span class="special">&lt;&lt;</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">native_handle</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span><span class="special">::</span><span class="identifier">read</span><span class="special">==</span><span class="identifier">optype</span> <span class="special">?</span>
        <span class="string">" read "</span> <span class="special">:</span> <span class="string">" wrote "</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="identifier">bytes_transferred</span> <span class="special">&lt;&lt;</span> <span class="string">" bytes at offset "</span> <span class="special">&lt;&lt;</span> <span class="identifier">offset</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">void</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">&gt;</span> <span class="identifier">dispatcher</span><span class="special">=</span>
        <span class="identifier">make_async_file_io_dispatcher</span><span class="special">();</span>

    <span class="comment">// Install filters BEFORE scheduling any ops as the filter APIs are NOT</span>
    <span class="comment">// threadsafe. This filters all file opens.</span>
    <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">post_op_filter</span><span class="special">({</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span><span class="special">::</span><span class="identifier">file</span> <span class="comment">/* just file opens */</span><span class="special">,</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">filter_t</span><span class="special">&gt;(</span><span class="identifier">open_file_filter</span><span class="special">))</span> <span class="special">});</span>

    <span class="comment">// This filters all reads and writes</span>
    <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">post_readwrite_filter</span><span class="special">({</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">detail</span><span class="special">::</span><span class="identifier">OpType</span><span class="special">::</span><span class="identifier">Unknown</span> <span class="comment">/* all */</span><span class="special">,</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">filter_readwrite_t</span><span class="special">&gt;(</span><span class="identifier">readwrite_filter</span><span class="special">))</span> <span class="special">});</span>
    <span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
<span class="special">}</span>
</pre>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2013, 2014 Niall Douglas and Paul Kirth<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="post_op_filter.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io_dispatcher_base.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../../afio.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="completion_2_batch_bound_functions.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
